name: Update token link

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */4 * * *"

permissions:
  contents: write

jobs:
  update-token:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch token and update link
        shell: bash
        run: |
          set -euo pipefail
          git pull --rebase origin "${GITHUB_REF_NAME}"
          issue_json=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/wzdnzd/aggregator/issues/91)
          token=$(ISSUE_JSON="$issue_json" python - <<'PY'
          import json
          import os
          import re
          import sys

          # Words to exclude when searching for token (common table values)
          EXCLUDED_WORDS = {"token", "details", "summary", "target", "clash", "v2ray", "singbox"}

          data = json.loads(os.environ["ISSUE_JSON"])
          body = data.get("body", "")
          token = None
          
          # Try to extract token from issue body
          lines = body.splitlines()
          for i, line in enumerate(lines):
              if not re.search(r"\\|\\s*token\\s*\\|", line, re.IGNORECASE):
                  continue
              
              # Method 1: Look for <details><summary>...</summary>TOKEN</details>
              details_match = re.search(r"<details>.*?<summary>.*?</summary>\\s*([A-Za-z0-9]{6,})", line, re.DOTALL)
              if details_match:
                  token = details_match.group(1)
                  break
              
              # Method 2: Look for `TOKEN` in code blocks
              code_match = re.search(r"`([A-Za-z0-9]{6,})`", line)
              if code_match:
                  token = code_match.group(1)
                  break
              
              # Method 3: Parse table cells and extract from index 6 (当前配置 column, 0-based)
              # Table format: | name | usage | required | range | default | current | notes |
              # Indices:        0      1       2          3       4         5         6       7
              cells = [c.strip() for c in line.split("|")]
              if len(cells) > 6:
                  config_cell = cells[6]
                  # Extract alphanumeric tokens, excluding common words
                  tokens = [
                      t for t in re.findall(r"[A-Za-z0-9]{6,}", config_cell)
                      if t.lower() not in EXCLUDED_WORDS
                  ]
                  if tokens:
                      token = tokens[0]
                      break
              
              # Method 4: Check next line (if table row is split)
              if i + 1 < len(lines):
                  next_line = lines[i + 1]
                  
                  # Look for <details> in next line
                  details_match = re.search(r"<details>.*?<summary>.*?</summary>\\s*([A-Za-z0-9]{6,})", next_line, re.DOTALL)
                  if details_match:
                      token = details_match.group(1)
                      break
                  
                  # Look for code block in next line
                  code_match = re.search(r"`([A-Za-z0-9]{6,})`", next_line)
                  if code_match:
                      token = code_match.group(1)
                      break
          
          if not token:
              sys.exit("token not found in issue body")
          print(token)
          PY
          )
          url="https://qybndbviblvt.us-west-1.clawcloudrun.com/api/v1/subscribe?token=${token}&target=Clash&list=false"
          run_at=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          {
            echo "# run_at: ${run_at}"
            echo "# source_url: ${url}"
            echo "# issue: https://github.com/wzdnzd/aggregator/issues/91"
            echo ""
          } > issues_91_latest.yml
          curl -fsSL "$url" >> issues_91_latest.yml

      - name: Commit changes
        shell: bash
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add issues_91_latest.yml
          git commit -m "Update latest token url"
          git push
